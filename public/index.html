<!DOCTYPE html>
<html>
<head>
  <title>Scratch Coding Hut Wiki</title>
  <style>
    body {
      background: #0f172a;
      color: #a5f3fc;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    h1 { 
      font-size: 2.5rem; 
      margin-bottom: 20px;
    }
    input, select, textarea, button {
      background: #1e293b;
      border: 1px solid #a5f3fc;
      color: #a5f3fc;
      padding: 20px;
      margin: 10px;
      border-radius: 10px;
      font-size: 1.2rem;
      width: 60vw;
    }
    select {
      width: 62vw;
    }
    textarea {
      height: 200px;
      resize: vertical;
    }
    .page {
      background: #1e293b;
      border: 1px solid #a5f3fc;
      padding: 20px;
      margin: 10px 0;
      width: 80vw;
      border-radius: 15px;
    }
    pre { 
      background: #334155; 
      padding: 10px; 
      border-radius: 10px; 
      overflow: auto; 
      max-height: 200px;
    }
    button { 
      cursor: pointer; 
    }
    .output {
      background: #334155;
      color: #facc15;
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<center>
<h1>Scratch Coding Hut Wiki</h1>

<input id="title" type="text" placeholder="Page Title" required>
<select id="extension" multiple>
  <option value="txt">Text</option>
  <option value="html">HTML</option>
  <option value="css">CSS</option>
  <option value="js">JavaScript</option>
  <option value="py">Python</option>
  <option value="node">Node.js</option>
  <option value="jsx">Next.js</option>
  <option value="swift">Swift</option>
  <option value="cs">C#</option>
  <option value="cpp">C++</option>
  <option value="c">C</option>
</select>
<textarea id="content" placeholder="Write your code or content here..."></textarea>
<button onclick="savePage()">Create/Update Page</button>

<div id="pages"></div>

</center>

<script>
  const API_URL = 'https://wiki-nqbp.onrender.com';

  let editingPageTitle = null;

  async function fetchPages() {
    const res = await fetch(`${API_URL}/pages`);
    const pages = await res.json();
    document.getElementById('pages').innerHTML = pages.map(page => `
      <div class="page">
        <h2>${page.title.split('.')[0]}</h2>
        <pre><code>${page.content}</code></pre>
        <button onclick="editPage('${page.title}', '${page.content.replace(/'/g, "\\'")}')">Edit</button>
        <button onclick="deletePage('${page.title}')">Delete</button>
        <button onclick="runCode('${page.title.split('.').pop()}', '${page.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')">Run</button>
        <div id="output-${page.title.split('.')[0]}" class="output"></div>
      </div>
    `).join('');
  }

  async function savePage() {
    const title = document.getElementById('title').value;
    const extensions = Array.from(document.getElementById('extension').selectedOptions).map(opt => opt.value);
    const content = document.getElementById('content').value;

    if (!title || !content) {
      alert("Please provide both title and content.");
      return;
    }

    const method = editingPageTitle ? 'PUT' : 'POST';
    const endpoint = editingPageTitle ? `${API_URL}/edit/${editingPageTitle}` : `${API_URL}/create`;

    await fetch(endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, extensions, content })
    });

    editingPageTitle = null;
    clearForm();
    fetchPages();
  }

  function editPage(title, content) {
    document.getElementById('title').value = title.split('.')[0];
    document.getElementById('content').value = content;
    editingPageTitle = title;
  }

  async function deletePage(title) {
    if (confirm('Are you sure you want to delete this page?')) {
      await fetch(`${API_URL}/delete/${title}`, { method: 'DELETE' });
      fetchPages();
    }
  }

  function clearForm() {
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';
    Array.from(document.getElementById('extension').options).forEach(opt => opt.selected = false);
  }

  function runCode(extension, code) {
    const outputDiv = document.getElementById(`output-${editingPageTitle.split('.')[0]}`);
    if (extension === 'js') {
      try {
        const result = eval(code);
        outputDiv.innerText = result !== undefined ? result : 'Code ran successfully!';
      } catch (err) {
        outputDiv.innerText = `Error: ${err.message}`;
      }
    } else if (extension === 'html') {
      const newWindow = window.open();
      newWindow.document.write(code);
      newWindow.document.close();
      outputDiv.innerText = 'HTML preview opened in a new tab!';
    } else if (extension === 'css') {
      const style = document.createElement('style');
      style.innerText = code;
      document.head.appendChild(style);
      outputDiv.innerText = 'CSS applied!';
    } else {
      outputDiv.innerText = 'Running this language is not supported in the browser.';
    }
  }

  fetchPages();
  setInterval(fetchPages, 200);
</script>
</body>
</html>
